#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –∏—Ö —Ü–µ–Ω—Ç—Ä–æ–∏–¥–æ–≤.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–æ–≤–∞—Ä—å –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏ –∏ –°–ù–ì.
"""

import json
from pathlib import Path
import csv
from math import radians, sin, cos, sqrt, atan2

def haversine_distance(lon1, lat1, lon2, lat2):
    """–í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ –ó–µ–º–ª–µ (–∫–º)"""
    R = 6371  # –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
    
    lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
    dlon = lon2 - lon1
    dlat = lat2 - lat1
    
    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    
    return R * c

def get_polygon_center(coordinates):
    """–í—ã—á–∏—Å–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä –ø–æ–ª–∏–≥–æ–Ω–∞"""
    if not coordinates or not coordinates[0]:
        return None
    
    ring = coordinates[0]
    lons = [p[0] for p in ring]
    lats = [p[1] for p in ring]
    
    return (sum(lons) / len(lons), sum(lats) / len(lats))

def get_polygon_bbox(coordinates):
    """–í—ã—á–∏—Å–ª—è–µ—Ç bbox –ø–æ–ª–∏–≥–æ–Ω–∞ [min_lon, min_lat, max_lon, max_lat]"""
    if not coordinates or not coordinates[0]:
        return None
    
    ring = coordinates[0]
    lons = [p[0] for p in ring]
    lats = [p[1] for p in ring]
    
    return [min(lons), min(lats), max(lons), max(lats)]

# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ä–æ–¥–æ–≤: (lon, lat, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å—Ç—Ä–∞–Ω–∞)
KNOWN_CITIES = [
    # –†–æ—Å—Å–∏—è - –∫—Ä—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
    (37.618, 55.751, '–ú–æ—Å–∫–≤–∞', '–†–æ—Å—Å–∏—è'),
    (30.315, 59.939, '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–†–æ—Å—Å–∏—è'),
    (39.720, 43.585, '–°–æ—á–∏', '–†–æ—Å—Å–∏—è'),
    (49.122, 55.796, '–ö–∞–∑–∞–Ω—å', '–†–æ—Å—Å–∏—è'),
    (60.597, 56.838, '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–†–æ—Å—Å–∏—è'),
    (82.920, 55.030, '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–†–æ—Å—Å–∏—è'),
    (37.775, 44.724, '–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫', '–†–æ—Å—Å–∏—è'),
    (38.051, 44.569, '–ì–µ–ª–µ–Ω–¥–∂–∏–∫', '–†–æ—Å—Å–∏—è'),
    (39.951, 43.430, '–¢—É–∞–ø—Å–µ', '–†–æ—Å—Å–∏—è'),
    (44.504, 40.189, '–ï—Ä–µ–≤–∞–Ω', '–ê—Ä–º–µ–Ω–∏—è'),
    (41.951, 45.036, '–í–ª–∞–¥–∏–∫–∞–≤–∫–∞–∑', '–†–æ—Å—Å–∏—è'),
    (43.607, 43.485, '–ì—Ä–æ–∑–Ω—ã–π', '–†–æ—Å—Å–∏—è'),
    (48.057, 46.349, '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å', '–†–æ—Å—Å–∏—è'),
    (40.240, 43.680, '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å', '–†–æ—Å—Å–∏—è'),
    (37.118, 45.053, '–ö–µ—Ä—á—å', '–†–æ—Å—Å–∏—è'),
    (37.339, 45.004, '–§–µ–æ–¥–æ—Å–∏—è', '–†–æ—Å—Å–∏—è'),
    (42.046, 44.222, '–ú–∞—Ö–∞—á–∫–∞–ª–∞', '–†–æ—Å—Å–∏—è'),
    (40.282, 44.557, '–ü—è—Ç–∏–≥–æ—Ä—Å–∫', '–†–æ—Å—Å–∏—è'),
    (40.068, 44.864, '–ö–∏—Å–ª–æ–≤–æ–¥—Å–∫', '–†–æ—Å—Å–∏—è'),
    
    # –°–∏–±–∏—Ä—å –∏ –£—Ä–∞–ª
    (73.368, 54.984, '–û–º—Å–∫', '–†–æ—Å—Å–∏—è'),
    (65.560, 57.153, '–¢—é–º–µ–Ω—å', '–†–æ—Å—Å–∏—è'),
    (56.025, 54.759, '–£—Ñ–∞', '–†–æ—Å—Å–∏—è'),
    (45.178, 54.197, '–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã', '–†–æ—Å—Å–∏—è'),
    (39.765, 47.255, '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', '–†–æ—Å—Å–∏—è'),
    (39.194, 51.675, '–í–æ—Ä–æ–Ω–µ–∂', '–†–æ—Å—Å–∏—è'),
    (39.567, 52.594, '–¢–∞–º–±–æ–≤', '–†–æ—Å—Å–∏—è'),
    (43.930, 56.289, '–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–†–æ—Å—Å–∏—è'),
    
    # –ü–æ–¥–º–æ—Å–∫–æ–≤—å–µ
    (37.751, 55.789, '–ú—ã—Ç–∏—â–∏', '–†–æ—Å—Å–∏—è'),
    (37.267, 55.677, '–û–¥–∏–Ω—Ü–æ–≤–æ', '–†–æ—Å—Å–∏—è'),
    (37.767, 55.425, '–î–æ–º–æ–¥–µ–¥–æ–≤–æ', '–†–æ—Å—Å–∏—è'),
    (37.320, 55.492, '–ö—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫', '–†–æ—Å—Å–∏—è'),
    (37.416, 55.596, '–•–∏–º–∫–∏', '–†–æ—Å—Å–∏—è'),
    (37.547, 55.450, '–í–∏–¥–Ω–æ–µ', '–†–æ—Å—Å–∏—è'),
    (37.454, 55.156, '–ü–æ–¥–æ–ª—å—Å–∫', '–†–æ—Å—Å–∏—è'),
    (37.177, 55.981, '–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥', '–†–æ—Å—Å–∏—è'),
    
    # –ü–æ–≤–æ–ª–∂—å–µ
    (44.779, 41.714, '–¢–±–∏–ª–∏—Å–∏', '–ì—Ä—É–∑–∏—è'),
    (45.012, 53.186, '–°–∞–º–∞—Ä–∞', '–†–æ—Å—Å–∏—è'),
    
    # –°–µ–≤–µ—Ä
    (35.884, 56.852, '–¢–≤–µ—Ä—å', '–†–æ—Å—Å–∏—è'),
    (39.870, 57.628, '–Ø—Ä–æ—Å–ª–∞–≤–ª—å', '–†–æ—Å—Å–∏—è'),
    (38.818, 58.050, '–ö–æ—Å—Ç—Ä–æ–º–∞', '–†–æ—Å—Å–∏—è'),
    (39.888, 59.207, '–í–æ–ª–æ–≥–¥–∞', '–†–æ—Å—Å–∏—è'),
    (34.329, 61.773, '–ü–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫', '–†–æ—Å—Å–∏—è'),
    (37.938, 59.114, '–¢–∏—Ö–≤–∏–Ω', '–†–æ—Å—Å–∏—è'),
    (38.439, 55.816, '–û—Ä–µ—Ö–æ–≤–æ-–ó—É–µ–≤–æ', '–†–æ—Å—Å–∏—è'),
    (38.973, 45.035, '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–†–æ—Å—Å–∏—è'),
    (61.368, 55.167, '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–†–æ—Å—Å–∏—è'),
    
    # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –†–æ—Å—Å–∏—è
    (37.624, 54.191, '–¢—É–ª–∞', '–†–æ—Å—Å–∏—è'),
    (36.026, 55.506, '–ö–∞–ª—É–≥–∞', '–†–æ—Å—Å–∏—è'),
    (37.428, 54.921, '–†—è–∑–∞–Ω—å', '–†–æ—Å—Å–∏—è'),
    (38.973, 55.805, '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å', '–†–æ—Å—Å–∏—è'),
    (39.510, 55.575, '–ù–æ–≥–∏–Ω—Å–∫', '–†–æ—Å—Å–∏—è'),
    (38.762, 55.088, '–ö–æ–ª–æ–º–Ω–∞', '–†–æ—Å—Å–∏—è'),
    (38.143, 56.303, '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤', '–†–æ—Å—Å–∏—è'),
    (36.269, 54.519, '–ö–∞–ª—É–≥–∞ –æ–±–ª–∞—Å—Ç—å', '–†–æ—Å—Å–∏—è'),
    
    # –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
    (76.901, 43.231, '–ê–ª–º–∞—Ç—ã', '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω'),
    (71.423, 51.147, '–ê—Å—Ç–∞–Ω–∞', '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω'),
    (78.396, 42.492, '–¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω', '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω'),
    
    # –ë–µ–ª–∞—Ä—É—Å—å
    (27.591, 53.912, '–ú–∏–Ω—Å–∫', '–ë–µ–ª–∞—Ä—É—Å—å'),
    (20.317, 54.951, '–ì—Ä–æ–¥–Ω–æ', '–ë–µ–ª–∞—Ä—É—Å—å'),
    
    # –ü—Ä–∏–±–∞–ª—Ç–∏–∫–∞
    (20.537, 54.727, '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', '–†–æ—Å—Å–∏—è'),
    (29.763, 59.996, '–í—ã–±–æ—Ä–≥', '–†–æ—Å—Å–∏—è'),
    (20.414, 44.817, '–ë–µ–ª–≥—Ä–∞–¥', '–°–µ—Ä–±–∏—è'),
    
    # –Æ–∂–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞
    (-74.804, 11.013, '–ë–∞—Ä—Ä–∞–Ω–∫–∏–ª—å—è', '–ö–æ–ª—É–º–±–∏—è'),
    (-77.025, -12.117, '–õ–∏–º–∞', '–ü–µ—Ä—É'),
]

def find_nearest_city(lon, lat, max_distance_km=100):
    """–ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥"""
    min_dist = float('inf')
    nearest = None
    
    for city_lon, city_lat, city_name, country in KNOWN_CITIES:
        dist = haversine_distance(lon, lat, city_lon, city_lat)
        if dist < min_dist:
            min_dist = dist
            nearest = (city_name, country, dist)
    
    if nearest and nearest[2] < max_distance_km:
        return nearest[0], nearest[1]
    
    return None, None

def main():
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞
    with open('output/cities.geojson') as f:
        cities_data = json.load(f)
    
    cities_info = []
    unknown_count = 0
    
    for feature in cities_data['features']:
        city_id = feature['id']
        center = get_polygon_center(feature['geometry']['coordinates'])
        bbox = get_polygon_bbox(feature['geometry']['coordinates'])
        
        if center and bbox:
            lon, lat = center
            city_name, country = find_nearest_city(lon, lat, max_distance_km=50)
            
            if not city_name:
                city_name = f'Unknown'
                country = 'Unknown'
                unknown_count += 1
            
            cities_info.append({
                'id': city_id,
                'name': city_name,
                'country': country,
                'lon': f'{lon:.6f}',
                'lat': f'{lat:.6f}',
                'bbox': f"{bbox[0]:.6f},{bbox[1]:.6f},{bbox[2]:.6f},{bbox[3]:.6f}"
            })
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–∞–Ω–µ –∏ –≥–æ—Ä–æ–¥—É
    cities_info.sort(key=lambda x: (x['country'], x['name'], x['id']))
    
    # –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
    print(f"üìã –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ ({len(cities_info)}):")
    print(f"{'=' * 100}")
    
    current_country = None
    for city in cities_info:
        if city['country'] != current_country:
            current_country = city['country']
            print(f"\nüåç {current_country}:")
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
        name_col = f"{city['name']:35}"
        id_col = f"{city['id']:40}"
        coords = f"{city['lon']:11}, {city['lat']:10}"
        print(f"   ‚Ä¢ {name_col} | {id_col} | {coords}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CSV
    csv_path = Path('cities_list.csv')
    with open(csv_path, 'w', encoding='utf-8', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=['id', 'name', 'country', 'lon', 'lat', 'bbox'])
        writer.writeheader()
        writer.writerows(cities_info)
    
    print(f"\n{'=' * 100}")
    print(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: {csv_path}")
    print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    print(f"   –í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤: {len(cities_info)}")
    print(f"   –û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: {len(cities_info) - unknown_count}")
    print(f"   –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: {unknown_count}")
    
    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
    countries = {}
    for city in cities_info:
        country = city['country']
        countries[country] = countries.get(country, 0) + 1
    
    print(f"\nüìç –ü–æ —Å—Ç—Ä–∞–Ω–∞–º:")
    for country, count in sorted(countries.items(), key=lambda x: -x[1]):
        print(f"   {country}: {count}")

if __name__ == '__main__':
    main()
